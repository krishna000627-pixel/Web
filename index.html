<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Website Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CRITICAL: Mobile Viewport Fix */
        body {
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: #1a1a1a;
            color: #e5e5e5;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #262626;
        }
        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #525252;
        }

        /* Syntax Highlighting Mock */
        .code-block {
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
        }

        /* Loader Animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans text-sm">

    <!-- App Container -->
    <div id="app" class="flex flex-1 w-full h-full overflow-hidden">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-neutral-900 border-r border-neutral-800 flex flex-col transition-all duration-300 transform -translate-x-full absolute z-20 h-full md:relative md:translate-x-0">
            <!-- Sidebar Header -->
            <div class="p-4 border-b border-neutral-800 flex justify-between items-center">
                <span class="font-bold text-lg text-white"><i class="fas fa-cube text-blue-500 mr-2"></i>Builder</span>
                <button id="closeSidebarBtn" class="md:hidden text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- New Project Button -->
            <div class="p-4">
                <button id="newProjectBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> New Project
                </button>
            </div>

            <!-- Project List -->
            <div class="flex-1 overflow-y-auto px-2 space-y-1" id="projectList">
                <!-- Projects injected here -->
            </div>

            <!-- Settings Trigger -->
            <div class="p-4 border-t border-neutral-800 mt-auto">
                <button id="openSettingsBtn" class="w-full flex items-center gap-3 text-gray-400 hover:text-white p-2 rounded-md hover:bg-neutral-800 transition-colors">
                    <i class="fas fa-cog"></i> Settings
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0 bg-neutral-900 relative">
            
            <!-- Header -->
            <header class="h-14 border-b border-neutral-800 flex items-center justify-between px-4 bg-neutral-900 z-10">
                <div class="flex items-center gap-4">
                    <button id="toggleSidebarBtn" class="md:hidden text-gray-400">
                        <i class="fas fa-bars"></i>
                    </button>
                    <!-- Traffic Dots -->
                    <div class="flex gap-2 group">
                        <div class="w-3 h-3 rounded-full bg-red-500 hover:bg-red-600"></div>
                        <div class="w-3 h-3 rounded-full bg-yellow-500 hover:bg-yellow-600"></div>
                        <div class="w-3 h-3 rounded-full bg-green-500 hover:bg-green-600"></div>
                    </div>
                </div>

                <!-- View Toggles -->
                <div class="bg-neutral-800 rounded-lg p-1 flex">
                    <button id="viewPreviewBtn" class="px-4 py-1.5 rounded-md text-xs font-medium bg-neutral-700 text-white shadow transition-all">
                        <i class="fas fa-eye mr-1"></i> Preview
                    </button>
                    <button id="viewCodeBtn" class="px-4 py-1.5 rounded-md text-xs font-medium text-gray-400 hover:text-white transition-all">
                        <i class="fas fa-code mr-1"></i> Code
                    </button>
                </div>

                <!-- Actions -->
                <button id="downloadBtn" class="text-gray-400 hover:text-blue-400 transition-colors" title="Download index.html">
                    <i class="fas fa-download"></i>
                </button>
            </header>

            <!-- Workspace -->
            <div class="flex-1 relative overflow-hidden bg-neutral-950">
                <!-- Preview View -->
                <div id="previewContainer" class="absolute inset-0 w-full h-full bg-white transition-opacity duration-300">
                    <iframe id="previewFrame" class="w-full h-full border-0" sandbox="allow-scripts allow-modals allow-forms allow-same-origin"></iframe>
                </div>
                
                <!-- Code View (Hidden by default) -->
                <div id="codeContainer" class="absolute inset-0 w-full h-full bg-[#1e1e1e] overflow-auto opacity-0 pointer-events-none transition-opacity duration-300 p-4">
                    <pre><code id="codeDisplay" class="text-green-400 font-mono text-sm language-html"></code></pre>
                </div>
                
                <!-- Overlay Loader -->
                <div id="generatingOverlay" class="absolute inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
                    <div class="bg-neutral-800 p-6 rounded-xl border border-neutral-700 shadow-2xl flex flex-col items-center gap-4">
                        <div class="loader"></div>
                        <p class="text-gray-300 animate-pulse">AI is building...</p>
                    </div>
                </div>
            </div>

            <!-- Footer / Chat Input -->
            <footer class="border-t border-neutral-800 p-4 bg-neutral-900 flex-shrink-0 z-10">
                <div class="relative max-w-4xl mx-auto">
                    <div class="flex gap-2 bg-neutral-800 p-2 rounded-xl border border-neutral-700 focus-within:border-blue-500 transition-colors">
                        <textarea id="promptInput" rows="1" class="w-full bg-transparent text-white resize-none border-0 focus:ring-0 p-2 max-h-32 placeholder-gray-500" placeholder="Describe the website you want to build..."></textarea>
                        <button id="sendBtn" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg w-10 h-10 flex items-center justify-center flex-shrink-0 transition-all">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </footer>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-neutral-900 w-full max-w-md rounded-xl border border-neutral-800 shadow-2xl overflow-hidden">
            <div class="p-4 border-b border-neutral-800 flex justify-between items-center bg-neutral-800/50">
                <h3 class="font-bold text-white">Settings</h3>
                <button id="closeSettingsBtn" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">API URL (OpenRouter/OpenAI)</label>
                    <input type="text" id="settingApiUrl" class="w-full bg-neutral-950 border border-neutral-800 rounded-lg p-2.5 text-white focus:border-blue-500 focus:outline-none transition-colors" placeholder="https://openrouter.ai/api/v1/chat/completions">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">API Key</label>
                    <div class="relative">
                        <input type="password" id="settingApiKey" class="w-full bg-neutral-950 border border-neutral-800 rounded-lg p-2.5 text-white focus:border-blue-500 focus:outline-none transition-colors" placeholder="sk-...">
                        <button id="toggleKeyVis" class="absolute right-3 top-2.5 text-gray-500 hover:text-gray-300">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-400 mb-1">Model ID</label>
                    <input type="text" id="settingModelId" class="w-full bg-neutral-950 border border-neutral-800 rounded-lg p-2.5 text-white focus:border-blue-500 focus:outline-none transition-colors" placeholder="deepseek/deepseek-r1:free">
                </div>
            </div>
            <div class="p-4 border-t border-neutral-800 bg-neutral-800/50 flex justify-end">
                <button id="saveSettingsBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    Save & Close
                </button>
            </div>
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        // --- CONSTANTS & CONFIG ---
        const SYSTEM_PROMPT = `You are an expert web developer. Your task is to generate complete, single-file HTML websites including embedded CSS and JavaScript based on user requests. 
        RULES:
        1. Return ONLY the raw HTML code. Do not wrap it in markdown (\`\`\`html). Do not include explanations.
        2. Use Tailwind CSS via CDN for styling.
        3. Use FontAwesome via CDN for icons.
        4. Make the design modern, responsive, and visually appealing.
        5. If updating an existing page, output the FULL updated code, not just diffs.`;

        const DEFAULTS = {
            apiUrl: "https://openrouter.ai/api/v1/chat/completions",
            modelId: "deepseek/deepseek-r1:free",
            apiKey: ""
        };

        // --- STATE MANAGEMENT ---
        let state = {
            projects: [],
            currentProjectId: null,
            settings: { ...DEFAULTS },
            isGenerating: false
        };

        // --- DOM ELEMENTS ---
        const els = {
            app: document.getElementById('app'),
            sidebar: document.getElementById('sidebar'),
            projectList: document.getElementById('projectList'),
            previewFrame: document.getElementById('previewFrame'),
            previewContainer: document.getElementById('previewContainer'),
            codeContainer: document.getElementById('codeContainer'),
            codeDisplay: document.getElementById('codeDisplay'),
            promptInput: document.getElementById('promptInput'),
            sendBtn: document.getElementById('sendBtn'),
            overlay: document.getElementById('generatingOverlay'),
            
            // Buttons
            newProjectBtn: document.getElementById('newProjectBtn'),
            openSettingsBtn: document.getElementById('openSettingsBtn'),
            saveSettingsBtn: document.getElementById('saveSettingsBtn'),
            closeSettingsBtn: document.getElementById('closeSettingsBtn'),
            closeSidebarBtn: document.getElementById('closeSidebarBtn'),
            toggleSidebarBtn: document.getElementById('toggleSidebarBtn'),
            viewPreviewBtn: document.getElementById('viewPreviewBtn'),
            viewCodeBtn: document.getElementById('viewCodeBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            toggleKeyVis: document.getElementById('toggleKeyVis'),

            // Settings Inputs
            settingApiUrl: document.getElementById('settingApiUrl'),
            settingApiKey: document.getElementById('settingApiKey'),
            settingModelId: document.getElementById('settingModelId'),
            settingsModal: document.getElementById('settingsModal'),
        };

        // --- INITIALIZATION ---
        function init() {
            loadState();
            renderProjectList();
            
            // If no projects, create one
            if (state.projects.length === 0) {
                createNewProject();
            } else {
                selectProject(state.projects[0].id);
            }

            setupEventListeners();
        }

        function loadState() {
            const savedSettings = localStorage.getItem('aiBuilder_settings');
            const savedProjects = localStorage.getItem('aiBuilder_projects');

            if (savedSettings) state.settings = JSON.parse(savedSettings);
            if (savedProjects) state.projects = JSON.parse(savedProjects);

            // Populate settings inputs
            els.settingApiUrl.value = state.settings.apiUrl;
            els.settingApiKey.value = state.settings.apiKey;
            els.settingModelId.value = state.settings.modelId;
        }

        function saveState() {
            localStorage.setItem('aiBuilder_settings', JSON.stringify(state.settings));
            localStorage.setItem('aiBuilder_projects', JSON.stringify(state.projects));
        }

        // --- PROJECT MANAGEMENT ---
        function createNewProject() {
            const newProject = {
                id: Date.now().toString(),
                name: `Project ${state.projects.length + 1}`,
                currentCode: "<!-- Your AI generated site will appear here -->\n<div style='display:flex;height:100vh;justify-content:center;align-items:center;font-family:sans-serif;color:#666;'><h1>Ready to build.</h1></div>",
                history: [] // Stores conversation context
            };
            state.projects.unshift(newProject);
            saveState();
            renderProjectList();
            selectProject(newProject.id);
        }

        function selectProject(id) {
            state.currentProjectId = id;
            const project = state.projects.find(p => p.id === id);
            
            // Update UI active state
            document.querySelectorAll('.project-item').forEach(el => {
                el.classList.remove('bg-neutral-800', 'text-white', 'border-l-4', 'border-blue-500');
                el.classList.add('text-gray-400', 'hover:bg-neutral-800/50');
            });
            const activeEl = document.getElementById(`proj-${id}`);
            if (activeEl) {
                activeEl.classList.remove('text-gray-400', 'hover:bg-neutral-800/50');
                activeEl.classList.add('bg-neutral-800', 'text-white', 'border-l-4', 'border-blue-500');
            }

            // Load Content
            updatePreview(project.currentCode);
            
            // On mobile, close sidebar after selection
            if (window.innerWidth < 768) {
                els.sidebar.classList.add('-translate-x-full');
            }
        }

        function renderProjectList() {
            els.projectList.innerHTML = '';
            state.projects.forEach(p => {
                const div = document.createElement('div');
                div.id = `proj-${p.id}`;
                div.className = 'project-item p-3 cursor-pointer rounded-r-md transition-all text-sm font-medium text-gray-400 hover:bg-neutral-800/50 border-l-4 border-transparent flex justify-between group';
                div.onclick = (e) => {
                    // Prevent deleting triggering selection
                    if(!e.target.closest('.delete-btn')) selectProject(p.id);
                };
                
                div.innerHTML = `
                    <span class="truncate">${p.name}</span>
                    <button class="delete-btn opacity-0 group-hover:opacity-100 text-neutral-500 hover:text-red-500 transition-opacity" title="Delete">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                
                // Delete handler
                div.querySelector('.delete-btn').onclick = (e) => {
                    e.stopPropagation();
                    deleteProject(p.id);
                };

                els.projectList.appendChild(div);
            });
        }

        function deleteProject(id) {
            if (!confirm('Delete this project?')) return;
            state.projects = state.projects.filter(p => p.id !== id);
            saveState();
            renderProjectList();
            if (state.projects.length === 0) createNewProject();
            else if (state.currentProjectId === id) selectProject(state.projects[0].id);
        }

        function updatePreview(html) {
            // Write to iframe
            const doc = els.previewFrame.contentDocument || els.previewFrame.contentWindow.document;
            doc.open();
            doc.write(html);
            doc.close();

            // Update code view
            els.codeDisplay.textContent = html;
        }

        // --- API & GENERATION LOGIC ---
        async function handleSend() {
            const prompt = els.promptInput.value.trim();
            if (!prompt) return;
            if (!state.settings.apiKey) {
                alert("Please set your API Key in Settings first.");
                els.settingsModal.classList.remove('hidden');
                return;
            }

            const project = state.projects.find(p => p.id === state.currentProjectId);
            
            // UI State: Loading
            state.isGenerating = true;
            els.overlay.classList.remove('hidden');
            els.promptInput.value = '';
            els.sendBtn.disabled = true;

            try {
                // Build Messages History
                const messages = [
                    { role: "system", content: SYSTEM_PROMPT },
                    ...project.history,
                    { role: "user", content: prompt }
                ];

                // *** CRITICAL FIX 2: Anti-Crash Fetch Logic ***
                const response = await fetch(state.settings.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.settings.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href, // Required by OpenRouter
                        'X-Title': 'AI Website Builder' // Required by OpenRouter
                    },
                    body: JSON.stringify({
                        model: state.settings.modelId,
                        messages: messages
                    })
                });

                const rawText = await response.text();

                if (!response.ok) {
                    throw new Error(`API Error ${response.status}: ${rawText}`);
                }

                let data;
                try {
                    data = JSON.parse(rawText);
                } catch (e) {
                    throw new Error("Failed to parse API response as JSON: " + rawText.substring(0, 100) + "...");
                }

                let aiContent = data.choices[0].message.content;
                
                // Clean markdown if present
                aiContent = aiContent.replace(/```html/g, '').replace(/```/g, '').trim();

                // Update Project State
                project.history.push({ role: "user", content: prompt });
                project.history.push({ role: "assistant", content: aiContent });
                project.currentCode = aiContent;
                
                // Save and Update UI
                saveState();
                updatePreview(aiContent);

            } catch (error) {
                console.error(error);
                alert("Generation Failed:\n" + error.message);
            } finally {
                state.isGenerating = false;
                els.overlay.classList.add('hidden');
                els.sendBtn.disabled = false;
            }
        }

        // --- UI INTERACTION HANDLERS ---
        function setupEventListeners() {
            // New Project
            els.newProjectBtn.onclick = createNewProject;

            // Settings
            els.openSettingsBtn.onclick = () => els.settingsModal.classList.remove('hidden');
            els.closeSettingsBtn.onclick = () => els.settingsModal.classList.add('hidden');
            els.saveSettingsBtn.onclick = () => {
                state.settings.apiUrl = els.settingApiUrl.value.trim();
                state.settings.apiKey = els.settingApiKey.value.trim();
                state.settings.modelId = els.settingModelId.value.trim();
                saveState();
                els.settingsModal.classList.add('hidden');
            };
            els.toggleKeyVis.onclick = () => {
                els.settingApiKey.type = els.settingApiKey.type === 'password' ? 'text' : 'password';
            };

            // Sidebar Toggles
            els.toggleSidebarBtn.onclick = () => els.sidebar.classList.remove('-translate-x-full');
            els.closeSidebarBtn.onclick = () => els.sidebar.classList.add('-translate-x-full');

            // View Modes
            els.viewPreviewBtn.onclick = () => {
                els.viewPreviewBtn.classList.replace('text-gray-400', 'text-white');
                els.viewPreviewBtn.classList.replace('hover:text-white', 'shadow');
                els.viewPreviewBtn.classList.add('bg-neutral-700');
                
                els.viewCodeBtn.classList.replace('text-white', 'text-gray-400');
                els.viewCodeBtn.classList.replace('shadow', 'hover:text-white');
                els.viewCodeBtn.classList.remove('bg-neutral-700');

                els.previewContainer.classList.remove('opacity-0', 'pointer-events-none');
                els.codeContainer.classList.add('opacity-0', 'pointer-events-none');
            };

            els.viewCodeBtn.onclick = () => {
                els.viewCodeBtn.classList.replace('text-gray-400', 'text-white');
                els.viewCodeBtn.classList.replace('hover:text-white', 'shadow');
                els.viewCodeBtn.classList.add('bg-neutral-700');

                els.viewPreviewBtn.classList.replace('text-white', 'text-gray-400');
                els.viewPreviewBtn.classList.replace('shadow', 'hover:text-white');
                els.viewPreviewBtn.classList.remove('bg-neutral-700');

                els.codeContainer.classList.remove('opacity-0', 'pointer-events-none');
                els.previewContainer.classList.add('opacity-0', 'pointer-events-none');
            };

            // Chat
            els.sendBtn.onclick = handleSend;
            els.promptInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });

            // Download
            els.downloadBtn.onclick = () => {
                const project = state.projects.find(p => p.id === state.currentProjectId);
                const blob = new Blob([project.currentCode], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'index.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
        }

        // Run
        init();

    </script>
</body>
</html>

